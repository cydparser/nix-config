#!/usr/bin/env bash

export NIXPKGS_LIST="$XDG_CACHE_HOME/nix/pkgs-list"

if [[ -n "$DARWIN" ]] && [[ -z "$SHELL" ]]; then
  # Needed by exec-path-from-shell-initialize (emacs).
  SHELL="$(which zsh)" || SHELL="$(which bash)"
fi

nix-q() {
  [[ -f "$NIXPKGS_LIST" ]] || nix-update
  rg -i "$1" "$NIXPKGS_LIST"
}

nix-update() {
  mkdir -p "$(dirname "$NIXPKGS_LIST")" \
    && sudo nix-channel --update \
    && {
      nix-env -qaP '*' --description;
      nix-env -qaP -A 'haskellPackages' -f '<nixpkgs>' --description;
      if nix eval '(<nu>)' 2>& /dev/null; then
        nix-env -qaP -A 'haskell.packages.ghc822' -f '<nu>';
      fi;
    } > "$NIXPKGS_LIST"
}
