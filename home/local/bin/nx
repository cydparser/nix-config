#!/usr/bin/env bash

function main {
  local cmd="${1:? Missing command}"
  shift
  case "$cmd" in
    b)    cmd=build ;;
    c)    cmd=channel ;;
    d)    cmd=diff ;;
    e)    cmd=env ;;
    ev)   cmd=eval ;;
    q)    cmd=query ;;
    r)    cmd=repl ;;
    rb)   cmd=rebuild ;;
    st)   cmd=store ;;
    s|sh) cmd=shell ;;
  esac

  case "$cmd" in
    build|channel|collect-garbage|copy-closure|daemon|diff|env|generate-config\
      |generate-patches|hash|info|install-package|instantiate|log2xml\
      |prefetch-git|prefetch-svn|prefetch-url|pull|push|query|shell|store)
      "nix-${cmd}" "$@"
      ;;
    build-vms|container|help|install|option|prepare-root|rebuild|version)
      "nixos-${cmd}" "$@"
      ;;
    gc)
      nix-store --gc "$@"
      ;;
    optimize)
      nix-store --optimise "$@"
      ;;
    pp)
      if [[ -n "$1" ]] && [[ -e "$1" ]]; then
        exec <"$1"
        shift
      fi
      exec pretty-derivation "$@"
      ;;
    run)
      nix-shell --run "$*"
      ;;
    squash)
      nix-collect-garbage --delete-old "$@"
      ;;
    *)
      nix "$cmd" "$@"
  esac
}

function nix-query {
  local qcmd="${1:? Missing query cmd}"
  : # TODO
  case "$qcmd" in

  esac
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  set -eo pipefail
  main "$@"
fi
